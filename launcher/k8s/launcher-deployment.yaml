apiVersion: v1
kind: ServiceAccount
metadata:
  name: launcher
  namespace: default

---
# Single Pod deployment â€” intended for running launcher as a single Pod on a node.
apiVersion: v1
kind: Pod
metadata:
  name: launcher
  namespace: default
  labels:
    app: launcher
spec:
  serviceAccountName: launcher
  containers:
    - name: launcher
      image: "launcher:latest" # replace with your registry/image
      imagePullPolicy: IfNotPresent
      ports:
        - containerPort: 50051
      env:
        - name: RUST_LOG
          value: info
        - name: LAUNCHER_DEFAULT_IMAGE
          value: "alpine/3.19"
        - name: USE_REAL_LXD
          value: "true"
        - name: USE_REAL_NETOPS
          value: "true"
        - name: LAUNCHER_SOCKET_PATH
          value: "/var/run/sandbox/launcher.sock"
        - name: LAUNCHER_HOST_PROC_PATH
          value: "/hostproc"
        - name: LAUNCHER_MACVLAN_PARENT_IF
          value: "eth0"
      securityContext:
        # least-privilege: only grant the network and sys_admin capabilities required
        # TODO: further restrict as needed
        privileged: true # Bidirectional mount propagation requires privileged mode
        capabilities:
          add: ["NET_ADMIN", "SYS_ADMIN"]
      volumeMounts:
        - name: lxd-socket
          mountPath: /var/snap/lxd/common/lxd/unix.socket
          readOnly: true
        - name: sandbox-dir
          mountPath: /var/run/sandbox
          mountPropagation: Bidirectional
        - name: hostproc
          mountPath: /hostproc
          readOnly: true
  volumes:
    - name: lxd-socket
      hostPath:
        path: /var/snap/lxd/common/lxd/unix.socket
        type: Socket
    - name: sandbox-dir
      hostPath:
        path: /var/run/sandbox
        type: Directory
    # TODO: consider using a more restricted mount than the full /proc
    - name: hostproc
      hostPath:
        path: /proc
        type: Directory